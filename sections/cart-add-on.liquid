{% schema %}
{
  "name": "Cart Add-on",
  "settings": [
	{
      "type": "checkbox",
      "id": "addon_enabled",
      "label": "Enable add-on product",
      "default": false,
      "info": "When enabled, the add-on product will be removed from the cart if it does not contain the main product."
    },
  	{
	   "type": "product",
	   "id": "main_product",
	   "label": "Main Product",
	   "info": "Select the main product."
	},
  	{
	   "type": "product",
	   "id": "addon_product",
	   "label": "Add-on Product",
	   "info": "Select the product to remove."
	}
  ]
}
{% endschema %}


{% if section.settings.addon_enabled and section.settings.main_product and section.settings.addon_product %}

{% comment %}

The following removes an add-on product if the main product is not in the cart.

{% endcomment %}

{% assign main_product = section.settings.main_product %}
{% assign addon_product = section.settings.addon_product %}
{% assign main_product_not_found = true %}

{% for item in cart.items %} 
  
  {% if item.product.handle == main_product %}
    {% assign main_product_not_found = false %}
  {% endif %}

  {% if item.product.handle == addon_product %}
    {% assign addon_product_found = true %}
    {% assign product = all_products[addon_product] %}
    {% assign add_on_id = product.variants.first.id %}
  {% endif %}

{% endfor %}

{% if addon_product_found and main_product_not_found %}
<script>
  (function($) {
  console.log('Need to remove')
  var cartUpdates = { {{ add_on_id }}: 0 }
    var params = {
      type: 'POST',
      url: '/cart/update.js',
      data: { updates: cartUpdates },
      dataType: 'json',
      success: function(stuff) { 
        window.top.location.href = '/cart';
      }
    };

    $.ajax(params);

  })(jQuery);
</script>
{% else %}
<script>console.log('Nothing to remove')</script>
{% endif %}

{% endif %}